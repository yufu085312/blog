{{/* å›ºå®šãƒšãƒ¼ã‚¸ï¼ˆé‹å–¶è€…æƒ…å ±ã€ãŠå•ã„åˆã‚ã›ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãªã©ï¼‰ã§ã¯è¡¨ç¤ºã—ãªã„ */}}
{{ if ne .Layout "page" }}
  {{ if .Params.showPopularArticles | default (.Site.Params.article.showPopularArticles | default false) }}
    {{ $popularLimit := .Site.Params.article.popularArticlesLimit | default 3 }}
    {{ $popularTitle := .Site.Params.article.popularArticlesTitle | default "äººæ°—è¨˜äº‹TOP3" }}
    
    {{/* é–²è¦§æ•°ãƒ™ãƒ¼ã‚¹ã®è¨˜äº‹URLãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ */}}
    {{ $popularUrls := site.Data.popular_articles | default slice }}
    {{ $popularArticles := slice }}

    {{ if $popularUrls }}
      {{/* JSONãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯URLã«ä¸€è‡´ã™ã‚‹è¨˜äº‹ã‚’å–å¾— */}}
      {{ range $url := $popularUrls }}
        {{ range where site.RegularPages "RelPermalink" $url }}
          {{ $popularArticles = $popularArticles | append . }}
        {{ end }}
      {{ end }}
    {{ else }}
      {{/* JSONãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å¾“æ¥é€šã‚ŠpopularRankã‚’ä½¿ç”¨ */}}
      {{ range where site.RegularPages "Type" "in" site.Params.mainSections }}
        {{ if .Params.popularRank }}
          {{ $popularArticles = $popularArticles | append . }}
        {{ end }}
      {{ end }}
      {{ $popularArticles = sort $popularArticles ".Params.popularRank" }}
    {{ end }}

    {{/* æŒ‡å®šã•ã‚ŒãŸä»¶æ•°ã«åˆ¶é™ */}}
    {{ $popularArticles = first $popularLimit $popularArticles }}
    
    {{ with $popularArticles }}
      <div class="popular-articles-sidebar mt-8">
        <h3 class="text-lg font-bold mb-4 text-neutral-900 dark:text-neutral-100">
          {{ $popularTitle | emojify }}
        </h3>
        
        <div class="space-y-3 popular-articles-list">
          {{ range $index, $article := . }}
            <a href="{{ $article.RelPermalink }}" class="popular-article-card block group">
              <article class="relative w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                {{/* ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒ */}}
                <div class="relative w-full overflow-hidden" style="aspect-ratio: 16/9;">
                  {{ $thumbnail := "" }}
                  {{ with $article.Resources.GetMatch "featured*" }}
                    {{ $thumbnail = .Resize "600x" }}
                  {{ end }}
                  
                  {{ if $thumbnail }}
                    <img src="{{ $thumbnail.RelPermalink }}" alt="{{ $article.Title }}" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                  {{ else }}
                    <div class="popular-rank-fallback w-full h-full flex items-center justify-center bg-neutral-100 dark:bg-neutral-700">
                      <span class="text-4xl text-neutral-300 dark:text-neutral-600">No Image</span>
                    </div>
                  {{ end }}
                  
                  {{/* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒãƒƒã‚¸ (å·¦ä¸Š) - ç”»åƒã‚³ãƒ³ãƒ†ãƒŠå†…ã«é…ç½®ã—ã€custom.cssã®è² ã®åº§æ¨™ã‚’ä¸Šæ›¸ã */}}
                  <div class="popular-rank-badge absolute w-8 h-8 flex items-center justify-center rounded-full text-white font-bold text-sm shadow-md pointer-events-none" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); z-index: 20; top: 0.5rem !important; left: 0.5rem !important;">
                    {{ add $index 1 }}
                  </div>
                </div>
                
                {{/* è¨˜äº‹æƒ…å ± */}}
                <div class="p-4">
                  <h4 class="text-base font-bold text-neutral-800 dark:text-neutral-100 line-clamp-2 mb-2 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
                    {{ $article.Title | emojify | safeHTML }}
                  </h4>
                  
                  <div class="text-xs text-neutral-500 dark:text-neutral-400 flex items-center gap-2">
                    <time datetime="{{ $article.Date.Format "2006-01-02" }}" class="flex items-center gap-1">
                      <span>ğŸ“…</span>
                      {{ $article.Date.Format "2006/01/02" }}
                    </time>
                  </div>
                </div>
              </article>
            </a>
          {{ end }}
        </div>
      </div>
    {{ end }}
  {{ end }}
{{ end }}
